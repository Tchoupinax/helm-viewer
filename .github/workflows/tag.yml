name: 4Ô∏è‚É£ Release üî•

on:
  push:
    tags:
    - "*"

jobs:
  update-version:
    name: "üì¶ Set package.json version from tag"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/create-github-app-token@v2
      id: app-token
      with:
        app-id: ${{ secrets.DEPLOY_APP_ID }}
        private-key: ${{ secrets.DEPLOY_APP_KEY }}
        owner: ${{ github.repository_owner }}

    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        token: ${{ steps.app-token.outputs.token }}

    - name: Use Node.js 25
      uses: actions/setup-node@v6
      with:
        node-version: 25

    - name: Get version from tag
      id: version
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Version: $VERSION"

    - name: Get GitHub App bot user
      id: app-user
      run: |
        resp=$(curl -s "https://api.github.com/users/mystique-as-code%5Bbot%5D")
        echo "$resp" | jq
        echo "login<<EOF" >> $GITHUB_OUTPUT
        echo "$(echo "$resp" | jq -r .login)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "id<<EOF" >> $GITHUB_OUTPUT
        echo "$(echo "$resp" | jq -r .id)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Configure git identity
      run: |
        git config --global user.name "${{ steps.app-user.outputs.login }}"
        git config --global user.email "${{ steps.app-user.outputs.id }}+${{ steps.app-user.outputs.login }}@users.noreply.github.com"

    - name: Update package.json version
      run: npm version $VERSION --no-git-tag-version
      working-directory: apps/cli
      env:
        VERSION: ${{ steps.version.outputs.version }}

    - name: Check build success ü¶´
      uses: tchoupinax/repo-config/shared-actions/steps/node/build@v0
      with:
        nodeVersion: 25
        pnpmVersion: 10.30.2
        workingDirectory: apps/cli

    - name: Commit changes
      run: |
        git add .
        git commit -m "chore: set version to ${{ steps.version.outputs.version }} [skip ci]"
        git push origin HEAD:master

    - name: Publish package on NPM üì¶
      run: npm publish
      working-directory: apps/cli
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  docker:
    name: Build official container üê≥
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
    - name: Build application ü¶´
      uses: tchoupinax/repo-config/shared-actions/steps/node/build@v0
      with:
        nodeVersion: 25
        pnpmVersion: 10.30.2
        workingDirectory: apps/webapp

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          tchoupinax/helm-viewer-webapp
        flavor: latest=true
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}

    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        context: apps/webapp
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
