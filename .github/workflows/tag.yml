name: 4Ô∏è‚É£ Release üî•

on:
  push:
    tags:
    - "*"

jobs:
  update-version:
    name: "üì¶ Set package.json version from tag"
    runs-on: ubuntu-latest
    permissions:
      # https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#adding-permissions-settings
      # https://docs.npmjs.com/trusted-publishers#supported-cicd-providers
      id-token: write # Required for OIDC
      contents: read

    steps:
    - uses: actions/create-github-app-token@v2
      id: app-token
      with:
        app-id: ${{ secrets.DEPLOY_APP_ID }}
        private-key: ${{ secrets.DEPLOY_APP_KEY }}

    - name: Get GitHub App User ID
      id: get-user-id
      run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}

    - id: committer
      run: echo "string=${{ steps.app-token.outputs.app-slug }}[bot] <${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com>"  >> "$GITHUB_OUTPUT"

    - run: echo "committer string is ${{ steps.committer.outputs.string }}"

    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ steps.app-token.outputs.token }}
        # Make sure the value of GITHUB_TOKEN will not be persisted in repo's config
        persist-credentials: false

    - name: Remove default auth header
      run: |
        git config --local --unset-all http.https://github.com/.extraheader || true
        git config --global --unset-all http.https://github.com/.extraheader || true

    - name: Use Node.js 25
      uses: actions/setup-node@v6
      with:
        node-version: 25

    - name: Get version from tag
      id: version
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Version: $VERSION"

    - name: Check build success ü¶´
      uses: tchoupinax/repo-config/shared-actions/steps/node/build@v0
      with:
        nodeVersion: 25
        pnpmVersion: 10.30.3
        workingDirectory: apps/cli

    - name: Debug git config
      run: |
        git config --global user.name "mystique-as-code[bot]"
        git config user.email "190078197+mystique-as-code[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ github.repository }}.git

        echo "---- REMOTE ----"
        git remote -v
        echo "---- EXTRAHEADER ----"
        git config --get-all http.https://github.com/.extraheader || echo "No extraheader"

    - name: Commit changes
      run: |
        git checkout master
        git pull origin master

        cd apps/cli
        npm version $VERSION --no-git-tag-version

        git config --global user.name "mystique-as-code[bot]"
        git config --global user.email "190078197+mystique-as-code[bot]@users.noreply.github.com"
           
        git add .
        git commit -m "chore: set version to ${{ steps.version.outputs.version }} [skip ci]" || echo "No changes to commit"
        git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ github.repository }}.git
        git push origin master
      env:
        VERSION: ${{ steps.version.outputs.version }}

    - name: Publish package on NPM üì¶
      run: npm publish
      working-directory: apps/cli
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
  #docker:
  #  name: Build official container üê≥
  #  runs-on: ubuntu-latest
  #  permissions:
  #    packages: write
  #  steps:
  #  - name: Build application ü¶´
  #    uses: tchoupinax/repo-config/shared-actions/steps/node/build@v0
  #    with:
  #      nodeVersion: 25
  #      pnpmVersion: 10.30.3
  #      workingDirectory: apps/webapp

  #  - name: Set up QEMU
  #    uses: docker/setup-qemu-action@v3

  #  - name: Set up Docker Buildx
  #    uses: docker/setup-buildx-action@v3

  #  - name: Log in to GitHub Container Registry
  #    uses: docker/login-action@v3
  #    with:
  #      registry: ghcr.io
  #      username: ${{ github.actor }}
  #      password: ${{ secrets.GITHUB_TOKEN }}

  #  - name: Login to Docker Hub
  #    uses: docker/login-action@v3
  #    with:
  #      username: ${{ secrets.DOCKERHUB_USERNAME }}
  #      password: ${{ secrets.DOCKERHUB_TOKEN }}

  #  - name: Docker meta
  #    id: meta
  #    uses: docker/metadata-action@v5
  #    with:
  #      images: |
  #        tchoupinax/helm-viewer-webapp
  #      flavor: latest=true
  #      tags: |
  #        type=ref,event=branch
  #        type=ref,event=pr
  #        type=semver,pattern={{version}}

  #  - name: Build and push
  #    uses: docker/build-push-action@v6
  #    with:
  #      context: apps/webapp
  #      platforms: linux/amd64,linux/arm64
  #      push: true
  #      tags: ${{ steps.meta.outputs.tags }}
  #      labels: ${{ steps.meta.outputs.labels }}
